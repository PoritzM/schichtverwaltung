<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Veranstaltungsdetails</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="header" onclick="Start()">Turnverein St. Ingbert</div>
    <div class="menu" onclick="toggleMenu()">☰</div>
    <ul class="menu-list" id="menuList">
        <li onclick="Start()">Startseite</li>
    </ul>

    <div class="content">
        <h1 id="eventName">Veranstaltung</h1>
        <div id="eventContent"></div>
    </div>

    <script>




        function toggleMenu() {
            const menu = document.getElementById('menuList');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function Start() {
            window.location.href = "Seite.html";
        }

        const urlParams = new URLSearchParams(window.location.search);
        const eventID = urlParams.get("eventID");

        if (eventID) {
            fetch(`http://localhost:8080/shifts/getShift/${eventID}`)
                .then(res => res.json())
                .then(event => {
                    document.getElementById("eventName").textContent = event.eventName;
                    const anzeigen = event.registerOnEvent;
                    const container = document.getElementById("eventContent");

                    event.days?.forEach((day, dayIndex) => {
                        const dayDiv = document.createElement("div");
                        dayDiv.classList.add("day");

                        const date = new Date(day.day);
                        const formattedDate = date.toLocaleDateString("de-DE", {
                            weekday: "long",
                            day: "2-digit",
                            month: "2-digit",
                            year: "numeric"
                        });

                        let signedUpDay = 0;
                        let neededDay = 0;
                        day.services?.forEach(service => {
                            service.tasks?.forEach(task => {
                                signedUpDay += task.workers?.length || 0;
                                neededDay += task.neededWorker || 0;
                            });
                        });

                        // Überschrift zum Einklappen
                        const header = document.createElement("h2");
                        header.style.cursor = "pointer";

                        // Pfeil-Icon hinzufügen
                        const arrow = document.createElement("span");
                        arrow.textContent = "▼"; // Anfangszustand: ausgeklappt
                        arrow.classList.add("arrow");
                        arrow.style.marginLeft = "10px";

                        // Text + Pfeil setzen
                        header.textContent = `Tag ${dayIndex + 1} | ${formattedDate} | ${signedUpDay} von ${neededDay} Personen eingetragen `;
                        header.appendChild(arrow); // Pfeil anhängen
                        dayDiv.appendChild(header);
                        

                        // Inhalt des Tages (einklappbar)
                        const dayContentDiv = document.createElement("div");
                        dayContentDiv.classList.add("dayContent");
                        dayContentDiv.style.display = "none"; // eingeklappt

                        header.addEventListener("click", () => {
                            const visible = dayContentDiv.style.display !== "none";
                            dayContentDiv.style.display = visible ? "none" : "block";
                            arrow.textContent = visible ? "▼" : "▶"; // Pfeil ändern
                        });


                        day.services?.forEach(service => {
                            const serviceDiv = document.createElement("div");
                            serviceDiv.classList.add("service");

                            let signedUpTotal = 0;
                            let neededTotal = 0;
                            service.tasks?.forEach(task => {
                                signedUpTotal += task.workers?.length || 0;
                                neededTotal += task.neededWorker || 0;
                            });

                            serviceDiv.innerHTML = `
                                    <h3>
                                        ${service.serviceDescription} | ${service.timeStart.slice(0, 5)} bis ${service.timeEnd.slice(0, 5)} Uhr |
                                        ${signedUpTotal} von ${neededTotal} Personen eingetragen
                                    </h3>
                                    <div class="line"></div>
                                `;

                            service.tasks?.forEach(task => {
                                const signedUp = task.workers?.length || 0;
                                const taskDiv = document.createElement("div");
                                taskDiv.classList.add("task");

                                let taskHTML = `<strong>${task.taskDescription}</strong> | ${signedUp} von ${task.neededWorker} Personen`;

                                if (anzeigen) {
                                    taskHTML += `
                                        <div class="signup">
                                            <input type="text" placeholder="Name" id="input-${event.eventID}-${day.dayID}-${service.serviceID}-${task.taskID}" onkeydown="if(event.key === 'Enter') Einschreiben(${event.eventID}, ${day.dayID}, ${service.serviceID}, ${task.taskID})" /> 
                                            <button id="anlegen" onclick="Einschreiben(${event.eventID}, ${day.dayID}, ${service.serviceID}, ${task.taskID})">Eintragen</button>
                                        </div>
                                    `;
                                }

                                if (signedUp > 0) {
                                    const names = task.workers.map(w => `
                                    <div class="worker">
                                        ${w.workerName}
                                        <button onclick="loescheWorker(${w.workerID})">Löschen</button>
                                    </div>
                                `).join("");
                                    taskHTML += names;
                                }

                                taskDiv.innerHTML = taskHTML;
                                serviceDiv.appendChild(taskDiv);
                            });

                            dayContentDiv.appendChild(serviceDiv);
                        });

                        // Füge den einklappbaren Inhalt und das Element hinzu
                        dayDiv.appendChild(dayContentDiv);
                        container.appendChild(dayDiv);

                        // Toggle-Funktion für Ein-/Ausklappen
                       
                    });

                })
                .catch(err => {
                    console.error("Fehler beim Laden des Events:", err);
                    document.getElementById("eventContent").innerHTML = "<p>Fehler beim Laden der Veranstaltungsdetails.</p>";
                });
        } else {
            document.getElementById("eventContent").innerHTML = "<p>Keine Veranstaltung ausgewählt.</p>";
        }


        function Einschreiben(eventID, dayID, serviceID, taskID) {
            const inputID = `input-${eventID}-${dayID}-${serviceID}-${taskID}`;
            const nameInput = document.getElementById(inputID);
            const workerName = nameInput?.value?.trim();

            if (!workerName) {
                alert("Bitte einen Namen eingeben.");
                return;
            }

            const payload = {
                worker: {
                    eventID,
                    dayID,
                    serviceID,
                    taskID,
                    workerName
                }
            };

            fetch("http://localhost:8080/shifts/addWorker", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            })

                .then(data => {
                    // Optional: Seite neu laden oder UI updaten
                    location.reload();
                })
                .catch(err => {
                    console.error("Fehler beim Eintragen:", err);
                    alert("Konnte nicht eintragen.");
                });
        }

        function loescheWorker(workerID) {
            fetch(`http://localhost:8080/shifts/deleteWorker/${workerID}`, {
                method: "DELETE"
            })
                .then(res => {
                    if (!res.ok) throw new Error("Löschen fehlgeschlagen");
                    return res.text(); // falls der Server nur "OK" zurückgibt
                })
                .then(() => {
                    location.reload(); // oder per DOM entfernen
                })
                .catch(err => {
                    console.error("Fehler beim Löschen:", err);
                    alert("Konnte nicht löschen.");
                });
        }





    </script>
</body>

</html>