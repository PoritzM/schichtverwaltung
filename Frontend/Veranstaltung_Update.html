<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <title>UPDATE DER VERANSTALTUNG </title>
</head>

<body>
    <div class="header" onclick="Start()">Turnverein St. Ingbert</div>

    <div class="menu" onclick="toggleMenu()">☰</div>
    <ul class="menu-list" id="menuList">
        <li onclick="Start()">Veranstaltung bearbeiten</li>
    </ul>

    <div id="eventContainer"></div>
    <button onclick="submitUpdate()" class="btn-green">Speichern</button>
    <div id="toast" class="toast"></div>

    <script src="utils.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const eventID = urlParams.get("eventID");

        let currentData;

        if (!eventID) {
            showToast("Keine Event-ID übergeben.", "error");
            throw new Error("eventID fehlt");
        }

        fetch(`http://localhost:8080/shifts/getShift/${eventID}`)
            .then(res => res.json())
            .then(data => {
                currentData = data;
                renderEvent(data);
            })
            .catch(err => {
                showToast("Fehler beim Laden der Veranstaltung.", "error");
            });

        function renderEvent(event) {
            const container = document.getElementById("eventContainer");
            container.innerHTML = "";

            const eventHeader = document.createElement("div");
            eventHeader.classList.add("event-header");
            eventHeader.innerHTML = `
        <div class="Name_der_veranstaltung">
          <label for="eventName">Name der Veranstaltung:</label>
          <input type="text" id="eventName" value="${event.eventName}" required>
        </div>
        <div class="Anzeige_der_veranstaltung">
          <input type="checkbox" id="showEvent" ${event.showEvent ? "checked" : ""}>
          <label for="showEvent">Veranstaltung anzeigen</label>
        </div>
        <div class="Eintragen_erlauben">
          <input type="checkbox" id="registerOnEvent" ${event.registerOnEvent ? "checked" : ""}>
          <label for="registerOnEvent">Eintragung erlauben</label>
        </div>
      `;
            container.appendChild(eventHeader);

            event.days.forEach((day, dayIndex) => {
                const dayDiv = document.createElement("div");
                dayDiv.classList.add("day-block");

                dayDiv.innerHTML = `
          <div id="Datum_container">
            <label for="Datum_eingeben" id="Datum_überschrift"><b>Datum:</b></label>
            <input type="date" id="Datum_eingeben" value="${day.day}" data-day-index="${dayIndex}" data-day-id="${day.dayID}" required>
          </div>
          <div class="servicesContainer"></div>
        `;

                const servicesContainer = dayDiv.querySelector(".servicesContainer");

                day.services.forEach((service, serviceIndex) => {
                    const serviceDiv = document.createElement("div");
                    serviceDiv.classList.add("service-block");

                    serviceDiv.innerHTML = `
            <label id="Service_überschrift"><b>Dienst</b></label>
            <div id="Service_container">
              <label>Dienstbeschreibung:</label>
              <input type="text" class="dienstName" value="${service.serviceDescription}" data-day-index="${dayIndex}" data-service-index="${serviceIndex}" required>
              <label>Startzeit:</label>
              <input type="time" class="startZeit" value="${service.timeStart}" data-day-index="${dayIndex}" data-service-index="${serviceIndex}" required>
              <label>Endzeit:</label>
              <input type="time" class="ndZeit" value="${service.timeEnd}" data-day-index="${dayIndex}" data-service-index="${serviceIndex}" required>
            </div>
            <div class="tasksContainer"></div>
          `;

                    const tasksContainer = serviceDiv.querySelector(".tasksContainer");

                    service.tasks.forEach((task, taskIndex) => {
                        const taskDiv = document.createElement("div");
                        taskDiv.classList.add("task-block");

                        taskDiv.innerHTML = `
              <label id="Task_überschrift"><b>Aufgabe</b></label>
              <div id="Task_container">
                <label>Aufgabe:</label>
                <input type="text" class="taskBeschreibung" value="${task.taskDescription}" data-day-index="${dayIndex}" data-service-index="${serviceIndex}" data-task-index="${taskIndex}" required>
                <label>Benötigte Personen:</label>
                <input type="number" min="1" step="1" class="taskPersonen" value="${task.neededWorker}" data-day-index="${dayIndex}" data-service-index="${serviceIndex}" data-task-index="${taskIndex}" required>
              </div>
            `;
                        tasksContainer.appendChild(taskDiv);
                    });

                    servicesContainer.appendChild(serviceDiv);
                });

                container.appendChild(dayDiv);
            });
        }

        function padSeconds(timeStr) {
            return timeStr.length === 5 ? timeStr + ":00" : timeStr;
        }



        function formatDateForBackend(dateInput) {
            const date = new Date(dateInput);
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

            const month = monthNames[date.getMonth()];
            const day = String(date.getDate()).padStart(2, '0');
            const year = date.getFullYear();

            let hours = date.getHours();
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            const ampm = hours >= 12 ? "PM" : "AM";

            hours = hours % 12;
            hours = hours ? hours : 12; // 0 => 12

            return `${month} ${day}, ${year}, ${hours}:${minutes}:${seconds} ${ampm}`;
        }


        function submitUpdate() {
            const now = new Date();
            const dayBlocks = document.querySelectorAll(".day-block");

            const updatedEvent = {
                eventID: currentData.eventID,
                eventName: document.getElementById("eventName").value,
                showEvent: document.getElementById("showEvent").checked,
                registerOnEvent: document.getElementById("registerOnEvent").checked,
                timeStamps: {
                    timeStampCreate: formatDateForBackend(currentData.timeStamps?.timeStampCreate || now),
                    timeStampEdit: formatDateForBackend(now)
                },
                days: Array.from(dayBlocks).map((dayBlock) => {
                    const dateInput = dayBlock.querySelector("input[type='date']");
                    const currentDayValue = dateInput.value;
                    const originalDayID = parseInt(dateInput.dataset.dayId) || -1;

                    const originalDayObj = currentData.days.find(d => d.dayID === originalDayID);
                    const dayChanged = originalDayObj && originalDayObj.day !== currentDayValue;
                    const effectiveDayID = (originalDayID !== -1 && !dayChanged) ? originalDayID : -1;

                    const serviceBlocks = dayBlock.querySelectorAll(".service-block");
                    const isNewDay = effectiveDayID === -1;

                    const services = Array.from(serviceBlocks).map((serviceBlock) => {
                        const serviceDescription = serviceBlock.querySelector(".dienstName").value;
                        const timeStart = padSeconds(serviceBlock.querySelector(".startZeit").value);
                        const timeEnd = padSeconds(serviceBlock.querySelector(".endZeit").value);

                        const taskBlocks = serviceBlock.querySelectorAll(".task-block");

                        const tasks = Array.from(taskBlocks).map((taskBlock) => {
                            const taskDescription = taskBlock.querySelector(".taskBeschreibung").value;
                            const neededWorker = parseInt(taskBlock.querySelector(".taskPersonen").value);

                            const origTask = originalDayObj?.services?.find(s =>
                                s.serviceDescription === serviceDescription &&
                                s.timeStart === timeStart &&
                                s.timeEnd === timeEnd
                            )?.tasks?.find(t =>
                                t.taskDescription === taskDescription &&
                                t.neededWorker === neededWorker
                            );

                            return {
                                taskID: origTask?.taskID ?? -1,
                                taskDescription,
                                neededWorker,
                                timeStamps: {
                                    timeStampCreate: formatDateForBackend(origTask?.timeStamps?.timeStampCreate || now),
                                    timeStampEdit: formatDateForBackend(now)
                                },
                                workers: origTask?.workers?.map(worker => ({
                                    workerID: worker.workerID,
                                    workerName: worker.workerName,
                                    timeStamps: {
                                        timeStampCreate: formatDateForBackend(worker.timeStamps?.timeStampCreate || now),
                                        timeStampEdit: formatDateForBackend(now)
                                    }
                                })) || []
                            };
                        });

                        const origService = originalDayObj?.services?.find(s =>
                            s.serviceDescription === serviceDescription &&
                            s.timeStart === timeStart &&
                            s.timeEnd === timeEnd
                        );

                        return {
                            serviceID: origService?.serviceID ?? -1,
                            serviceDescription,
                            timeStart,
                            timeEnd,
                            timeStamps: {
                                timeStampCreate: formatDateForBackend(origService?.timeStamps?.timeStampCreate || now),
                                timeStampEdit: formatDateForBackend(now)
                            },
                            tasks
                        };
                    });

                    return {
                        dayID: effectiveDayID,
                        day: currentDayValue,
                        timeStamps: {
                            timeStampCreate: formatDateForBackend(originalDayObj?.timeStamps?.timeStampCreate || now),
                            timeStampEdit: formatDateForBackend(now)
                        },
                        services
                    };
                })

            };

            console.log("Gesendetes JSON:", JSON.stringify(updatedEvent, null, 2));

            fetch("http://localhost:8080/shifts/updateShift", {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ event: updatedEvent })

            })
                .then(res => {
                    if (!res.ok) throw new Error("Update fehlgeschlagen");
                    return res.text();
                })
                .then(() => {
                    showToast("Veranstaltung erfolgreich aktualisiert.", "success");
                })
                .catch(err => {
                    showToast("Fehler beim Aktualisieren: " + err.message, "error");
                });
        }

    </script>
</body>

</html>